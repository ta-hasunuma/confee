# アーキテクチャ & インフラ構成

Confee システムのインフラ構成、ワークフロー、および各 AWS サービスの採用理由をまとめたドキュメント。

---

## 1. システム概要

Confee は、ユーザーの自然言語クエリに基づいて技術カンファレンス情報を検索・推薦する AI エージェントアプリケーション。フロントエンド（React SPA）、API レイヤー（API Gateway + Lambda）、AI エージェント（Bedrock AgentCore + Strands Agent）の 3 層で構成される。

### 全体アーキテクチャ

```
                            ┌─────────────────────────────────────────────┐
                            │          ConfeeFrontendStack                │
  ┌──────────┐   HTTPS      │  ┌──────────────┐  OAC  ┌───────────────┐  │
  │          │─────────────▶│  │  CloudFront   │──────▶│   Amazon S3   │  │
  │          │              │  │  (CDN+HTTPS)  │       │ (静的ホスト)  │  │
  │          │              │  └──────────────┘       └───────────────┘  │
  │ ユーザー │              └─────────────────────────────────────────────┘
  │(ブラウザ)│
  │          │              ┌─────────────────────────────────────────────┐
  │          │  POST /chat  │              ConfeeApiStack                 │
  │          │  GET /health │  ┌──────────────┐       ┌───────────────┐  │
  │          │─────────────▶│  │ API Gateway  │──────▶│ Health Lambda │  │
  └──────────┘              │  │  (REST API)  │       └───────────────┘  │
                            │  └──────┬───────┘       ┌───────────────┐  │
                            │         └──────────────▶│  Chat Lambda  │  │
                            │                          │  (Proxy)      │  │
                            │                          └───────┬───────┘  │
                            │  ┌───────────────┐               │         │
                            │  │Secrets Manager│◁ ─ ─ ─ ─ ─ ─ ┘         │
                            │  │(connpass key) │                          │
                            │  └───────────────┘                          │
                            └──────────────────────────────┬──────────────┘
                                                           │
                                              InvokeAgentRuntime (SigV4)
                                                           │
                            ┌──────────────────────────────▼──────────────┐
                            │         ConfeeAgentCoreStack                │
                            │                                             │
                            │  ┌───────────────────────────────────────┐  │
                            │  │     Bedrock AgentCore Runtime         │  │
                            │  │            (microVM)                  │  │
                            │  │                                       │  │
                            │  │  ┌─────────────┐  ┌───────────────┐  │  │
                            │  │  │Strands Agent│─▶│ Bedrock LLM   │  │  │
                            │  │  │(ConfeeAgent)│  │ (Nova Micro)  │  │  │
                            │  │  └──────┬──────┘  └───────────────┘  │  │
                            │  │         │                             │  │
                            │  └─────────┼─────────────────────────────┘  │
                            │            │                                │
                            │  ┌─────────┘  ┌──────────┐  ┌──────────┐  │
                            │  │            │   ECR    │  │ IAM Role │  │
                            │  │            │ (Image)  │  │          │  │
                            │  │            └──────────┘  └──────────┘  │
                            │  │                                        │
                            └──┼────────────────────────────────────────┘
                               │ search_connpass
                               ▼
                        ┌──────────────┐
                        │connpass API  │
                        │    v2        │
                        │(イベント情報)│
                        └──────────────┘
```

---

## 2. インフラ構成

AWS CDK（TypeScript）で 3 つの独立したスタックとして管理。

### スタック一覧

| スタック | 責務 | 主なリソース |
|---------|------|------------|
| **ConfeeAgentCoreStack** | AI エージェントのホスティング | ECR, IAM Role, Custom Resource Lambda x2, AgentCore Runtime |
| **ConfeeApiStack** | REST API レイヤー | Secrets Manager, Lambda (Health/Chat), API Gateway |
| **ConfeeFrontendStack** | フロントエンド配信 | S3 Bucket, CloudFront Distribution, BucketDeployment |

### スタック間の依存関係

```
  ConfeeAgentCoreStack ──agentRuntimeArn──▶ ConfeeApiStack
                                                               ConfeeFrontendStack (独立)
```

- `ConfeeApiStack` は `ConfeeAgentCoreStack` の `agentRuntimeArn` を受け取る
- `ConfeeFrontendStack` は他のスタックに依存しない

### リソース詳細

| スタック | リソース | 設定 |
|---------|---------|------|
| AgentCoreStack | ECR Docker Image Asset | ARM64, `agent/` ディレクトリからビルド |
| AgentCoreStack | IAM Role | `bedrock-agentcore.amazonaws.com` 信頼、Bedrock/ECR/CloudWatch 権限 |
| AgentCoreStack | Custom Resource Lambda (onEvent) | Python 3.13, タイムアウト 5 分 |
| AgentCoreStack | Custom Resource Lambda (isComplete) | Python 3.13, タイムアウト 5 分, 30 秒間隔ポーリング |
| AgentCoreStack | AgentCore Runtime | `confee_agent`, PUBLIC ネットワーク, 最大 30 分で作成完了 |
| ApiStack | Secrets Manager | `confee/connpass-api-key` |
| ApiStack | Lambda (Health) | Python 3.13, タイムアウト 10 秒 |
| ApiStack | Lambda (Chat) | Python 3.13, タイムアウト 30 秒, `AGENT_RUNTIME_ARN` 環境変数 |
| ApiStack | API Gateway REST API | CORS 全オリジン許可, `/health` (GET), `/chat` (POST) |
| FrontendStack | S3 Bucket | パブリックアクセスブロック, 自動削除有効 |
| FrontendStack | CloudFront | HTTPS リダイレクト, SPA ルーティング (403/404 → index.html) |
| FrontendStack | BucketDeployment | `frontend/dist` → S3, CloudFront キャッシュ無効化 |

---

## 3. AWS サービスの採用理由・メリット・デメリット

### Amazon CloudFront

| 項目 | 内容 |
|------|------|
| **採用理由** | React SPA の HTTPS 配信と CDN キャッシュによる高速化 |
| **メリット** | グローバルエッジロケーションによる低レイテンシ配信、自動 HTTPS 対応、SPA ルーティング（403/404 → index.html）に対応、S3 への直接アクセスを遮断し OAC でセキュアに配信 |
| **デメリット** | キャッシュ無効化に時間がかかる場合がある、設定変更のデプロイに数分かかる、MVP 規模ではオーバースペックになりうる |

### Amazon S3

| 項目 | 内容 |
|------|------|
| **採用理由** | React SPA のビルド成果物（静的ファイル）のホスティング |
| **メリット** | 高い耐久性 (99.999999999%)、サーバー管理不要、従量課金で MVP に適したコスト、CDK の BucketDeployment でデプロイ自動化 |
| **デメリット** | 単体では HTTPS 非対応（CloudFront と併用が必要）、動的コンテンツの配信には不向き |

### Amazon API Gateway (REST API)

| 項目 | 内容 |
|------|------|
| **採用理由** | Lambda 関数への HTTP エンドポイント提供、CORS 設定の一元管理 |
| **メリット** | マネージドで高可用性、CORS 設定の組み込みサポート、Lambda との統合が容易、スロットリング・レート制限機能を内蔵 |
| **デメリット** | REST API は HTTP API と比べてコストが高い、レスポンスのペイロード上限 10MB、コールドスタートが追加のレイテンシ要因になりうる |

### AWS Lambda

| 項目 | 内容 |
|------|------|
| **採用理由** | Chat プロキシ（SigV4 認証で AgentCore を呼び出し）とヘルスチェックのサーバーレス実行 |
| **メリット** | サーバー管理不要、リクエスト単位の従量課金で MVP に最適、自動スケーリング、Python 3.13 ランタイムでエージェント側と言語統一 |
| **デメリット** | コールドスタートによるレイテンシ、実行時間上限（Chat Lambda は 30 秒）、ローカルデバッグが煩雑 |

### Amazon Bedrock AgentCore Runtime

| 項目 | 内容 |
|------|------|
| **採用理由** | Strands Agent のマネージドホスティング。セッション分離・自動スケーリングを提供 |
| **メリット** | microVM によるセッション分離、インフラ管理不要で Agent をデプロイ可能、Bedrock モデルとのネイティブ統合、コンテナイメージベースで柔軟なカスタマイズ |
| **デメリット** | 初回デプロイに最大 30 分かかる、比較的新しいサービスで情報・事例が少ない、デバッグが困難（microVM 内部にアクセスできない）、Custom Resource による管理が複雑 |

### Amazon Bedrock (LLM)

| 項目 | 内容 |
|------|------|
| **採用理由** | 推薦ロジックの自然言語処理。日本語対応の LLM をマネージドサービスとして利用 |
| **使用モデル** | `apac.amazon.nova-micro-v1:0` (Amazon Nova Micro) |
| **メリット** | AWS ネイティブで IAM 認証のみで利用可能、API キー管理不要、複数モデルを切り替え可能、従量課金 |
| **デメリット** | リージョン制限あり（APAC クロスリージョン推論を使用）、モデルの応答品質はモデル選択に依存、コスト予測が困難（トークン単位課金） |

### Amazon ECR

| 項目 | 内容 |
|------|------|
| **採用理由** | エージェントの Docker コンテナイメージの保存先 |
| **メリット** | CDK の DockerImageAsset で自動ビルド・プッシュ、IAM による安全なアクセス制御、AgentCore Runtime との統合がシームレス |
| **デメリット** | イメージストレージのコストが発生、ライフサイクルポリシー未設定の場合に古いイメージが蓄積 |

### AWS Secrets Manager

| 項目 | 内容 |
|------|------|
| **採用理由** | connpass API キーのセキュアな管理 |
| **メリット** | 暗号化された安全なシークレット保管、IAM ポリシーによるアクセス制御、Lambda からの取得が容易、自動ローテーション機能（将来利用可能） |
| **デメリット** | シークレットあたり月額料金が発生、環境変数と比べて取得にレイテンシが追加される |

### AWS IAM

| 項目 | 内容 |
|------|------|
| **採用理由** | サービス間の認証・認可 |
| **メリット** | 最小権限の原則をポリシーで実現、サービス間通信のセキュリティ確保、CDK で宣言的に管理可能 |
| **デメリット** | ポリシー設定の複雑さ、過剰な権限設定のリスク（一部 `"*"` リソース指定あり） |

### AWS CDK (TypeScript)

| 項目 | 内容 |
|------|------|
| **採用理由** | インフラのコード化 (IaC) と再現可能なデプロイ |
| **メリット** | TypeScript による型安全なインフラ定義、高レベル Construct で記述量削減、スタック間の依存関係を自動解決、テスト可能（Jest） |
| **デメリット** | 学習コストが CloudFormation テンプレートより高い、CDK バージョンアップへの追従が必要、Custom Resource の実装が複雑 |

---

## 4. ワークフロー シーケンス図

### 4.1 チャットリクエスト（正常系）

ユーザーがメッセージを送信してから応答を受け取るまでの完全なフロー。

```
  ユーザー        React SPA       API Gateway     Chat Lambda     AgentCore      Strands Agent    Bedrock LLM    connpass API
    │            (ChatContainer)                                   (microVM)      (ConfeeAgent)    (Nova Micro)       v2
    │                 │                │                │               │               │               │              │
    │ メッセージ入力  │                │                │               │               │               │              │
    │────────────────▶│                │                │               │               │               │              │
    │                 │                │                │               │               │               │              │
    │                 │─┐ ローカル state に追加         │               │               │               │              │
    │                 │◀┘ ローディング表示開始          │               │               │               │              │
    │                 │                │                │               │               │               │              │
    │                 │ POST /chat     │                │               │               │               │              │
    │                 │ {message,      │                │               │               │               │              │
    │                 │  session_id}   │                │               │               │               │              │
    │                 │───────────────▶│                │               │               │               │              │
    │                 │                │                │               │               │               │              │
    │                 │                │ Lambda統合     │               │               │               │              │
    │                 │                │───────────────▶│               │               │               │              │
    │                 │                │                │               │               │               │              │
    │                 │                │                │─┐ JSONパース  │               │               │              │
    │                 │                │                │◀┘ バリデーション               │               │              │
    │                 │                │                │               │               │               │              │
    │                 │                │                │ Invoke        │               │               │              │
    │                 │                │                │ AgentRuntime  │               │               │              │
    │                 │                │                │ (SigV4認証)   │               │               │              │
    │                 │                │                │──────────────▶│               │               │              │
    │                 │                │                │               │               │               │              │
    │                 │                │                │               │ invoke(prompt) │               │              │
    │                 │                │                │               │──────────────▶│               │              │
    │                 │                │                │               │               │               │              │
    │                 │                │                │               │               │ プロンプト +   │              │
    │                 │                │                │               │               │ システムプロンプト             │
    │                 │                │                │               │               │──────────────▶│              │
    │                 │                │                │               │               │               │              │
    │                 │                │                │               │               │ ツール呼び出し │              │
    │                 │                │                │               │               │ 判断           │              │
    │                 │                │                │               │               │◁ ─ ─ ─ ─ ─ ─ ┤              │
    │                 │                │                │               │               │               │              │
    │                 │                │                │               │               │ GET /api/v2/events/           │
    │                 │                │                │               │               │ ?keyword=...&count=10         │
    │                 │                │                │               │               │─────────────────────────────▶│
    │                 │                │                │               │               │               │              │
    │                 │                │                │               │               │               │  イベントデータ
    │                 │                │                │               │               │               │    (JSON)    │
    │                 │                │                │               │               │◁ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ┤
    │                 │                │                │               │               │               │              │
    │                 │                │                │               │               │ ツール結果 +   │              │
    │                 │                │                │               │               │ コンテキスト   │              │
    │                 │                │                │               │               │──────────────▶│              │
    │                 │                │                │               │               │               │              │
    │                 │                │                │               │               │   Markdown形式 │              │
    │                 │                │                │               │               │   推薦テキスト │              │
    │                 │                │                │               │               │◁ ─ ─ ─ ─ ─ ─ ┤              │
    │                 │                │                │               │               │               │              │
    │                 │                │                │               │  {response}    │               │              │
    │                 │                │                │               │◁ ─ ─ ─ ─ ─ ─ ┤               │              │
    │                 │                │                │               │               │               │              │
    │                 │                │                │  レスポンス    │               │               │              │
    │                 │                │                │◁ ─ ─ ─ ─ ─ ─ ┤               │               │              │
    │                 │                │                │               │               │               │              │
    │                 │                │  HTTP 200      │               │               │               │              │
    │                 │                │  {response,    │               │               │               │              │
    │                 │                │   session_id}  │               │               │               │              │
    │                 │                │◁ ─ ─ ─ ─ ─ ─ ┤               │               │               │              │
    │                 │                │                │               │               │               │              │
    │                 │ JSON レスポンス│                │               │               │               │              │
    │                 │◁ ─ ─ ─ ─ ─ ─ ┤                │               │               │               │              │
    │                 │                │                │               │               │               │              │
    │                 │─┐ session_id 更新               │               │               │               │              │
    │                 │◀┘ Markdown レンダリング         │               │               │               │              │
    │                 │                │                │               │               │               │              │
    │  推薦結果を表示 │                │                │               │               │               │              │
    │◁ ─ ─ ─ ─ ─ ─ ─┤                │                │               │               │               │              │
    │                 │                │                │               │               │               │              │
```

### 4.2 初回アクセス（おすすめプロンプト表示）

```
  ユーザー        React SPA
    │                 │
    │ アプリにアクセス │
    │────────────────▶│
    │                 │
    │                 │─┐ session_id 生成 (crypto.randomUUID)
    │                 │◀┘
    │                 │
    │                 │─┐ SuggestedPrompts 表示
    │                 │◀┘ "TypeScriptのカンファレンスある？"
    │                 │   "面白そうなイベント教えて" など
    │                 │
    │ おすすめプロンプト│
    │ を表示          │
    │◁ ─ ─ ─ ─ ─ ─ ─┤
    │                 │
    │ プロンプトを     │
    │ クリック         │
    │────────────────▶│
    │                 │
    │                 │─┐ SuggestedPrompts 非表示
    │                 │◀┘ 選択テキストで handleSend 実行
    │                 │
    │                 │   ※ 以降は 4.1 の正常系フローと同じ
    │                 │
```

### 4.3 エラー系

#### connpass API タイムアウト

```
  ユーザー      React SPA     API Gateway   Chat Lambda   AgentCore    Strands Agent   Bedrock LLM   connpass API
    │               │              │              │             │              │              │             │
    │ メッセージ送信│              │              │             │              │              │             │
    │──────────────▶│              │              │             │              │              │             │
    │               │ POST /chat   │              │             │              │              │             │
    │               │─────────────▶│              │             │              │              │             │
    │               │              │─────────────▶│             │              │              │             │
    │               │              │              │────────────▶│              │              │             │
    │               │              │              │             │─────────────▶│              │             │
    │               │              │              │             │              │─────────────▶│             │
    │               │              │              │             │              │  search_     │             │
    │               │              │              │             │              │  connpass    │             │
    │               │              │              │             │              │◁ ─ ─ ─ ─ ─ ┤             │
    │               │              │              │             │              │              │             │
    │               │              │              │             │              │ GET /api/v2/events/        │
    │               │              │              │             │              │────────────────────────────▶│
    │               │              │              │             │              │              │             │
    │               │              │              │             │              │              │  ×× 5秒経過 │
    │               │              │              │             │              │              │  タイムアウト│
    │               │              │              │             │              │◁ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ×│
    │               │              │              │             │              │              │             │
    │               │              │              │             │              │─┐ エラー情報を受け取る    │
    │               │              │              │             │              │◀┘ {error: true}           │
    │               │              │              │             │              │              │             │
    │               │              │              │             │              │ エラーコンテキスト送信     │
    │               │              │              │             │              │─────────────▶│             │
    │               │              │              │             │              │              │             │
    │               │              │              │             │              │  ユーザー向け│             │
    │               │              │              │             │              │  エラーメッセージ生成      │
    │               │              │              │             │              │◁ ─ ─ ─ ─ ─ ┤             │
    │               │              │              │             │              │              │             │
    │               │              │              │             │◁ ─ ─ ─ ─ ─ ┤              │             │
    │               │              │              │◁ ─ ─ ─ ─ ─ ┤             │              │             │
    │               │              │  HTTP 200    │             │              │              │             │
    │               │              │◁ ─ ─ ─ ─ ─ ┤             │              │              │             │
    │               │◁ ─ ─ ─ ─ ─ ┤              │             │              │              │             │
    │               │              │              │             │              │              │             │
    │ "接続がタイム  │              │              │             │              │              │             │
    │  アウトしまし  │              │              │             │              │              │             │
    │  た。再度お試  │              │              │             │              │              │             │
    │  しください"   │              │              │             │              │              │             │
    │◁ ─ ─ ─ ─ ─ ─┤              │              │             │              │              │             │
    │               │              │              │             │              │              │             │
```

#### AgentCore 障害 (503)

```
  ユーザー      React SPA     API Gateway   Chat Lambda   AgentCore
    │               │              │              │             │
    │ メッセージ送信│              │              │             │
    │──────────────▶│              │              │             │
    │               │ POST /chat   │              │             │
    │               │─────────────▶│              │             │
    │               │              │─────────────▶│             │
    │               │              │              │────────────▶│
    │               │              │              │             │
    │               │              │              │ ×× 例外発生 │
    │               │              │              │◁ ─ ─ ─ ─ ×│
    │               │              │              │             │
    │               │              │              │─┐ 例外ログ出力
    │               │              │              │◀┘ (CloudWatch)
    │               │              │              │             │
    │               │              │  HTTP 503    │             │
    │               │              │  {error:     │             │
    │               │              │   "Service   │             │
    │               │              │   unavail."} │             │
    │               │              │◁ ─ ─ ─ ─ ─ ┤             │
    │               │              │              │             │
    │               │ 503 レスポンス              │             │
    │               │◁ ─ ─ ─ ─ ─ ┤              │             │
    │               │              │              │             │
    │               │─┐ ChatApiError (status: 503)│             │
    │               │◀┘                           │             │
    │               │              │              │             │
    │ "サービスが一時│              │              │             │
    │  的に利用でき  │              │              │             │
    │  ません"       │              │              │             │
    │◁ ─ ─ ─ ─ ─ ─┤              │              │             │
    │               │              │              │             │
```

#### セッションタイムアウト (408)

```
  ユーザー      React SPA     API Gateway
    │               │              │
    │ メッセージ送信│              │
    │ (長時間放置後)│              │
    │──────────────▶│              │
    │               │ POST /chat   │
    │               │ {session_id: │
    │               │  "old-..."}  │
    │               │─────────────▶│
    │               │              │
    │               │  HTTP 408    │
    │               │  セッション  │
    │               │  タイムアウト│
    │               │◁ ─ ─ ─ ─ ─ ┤
    │               │              │
    │               │─┐ ChatApiError (status: 408)
    │               │◀┘ 新しい session_id を自動生成
    │               │              │
    │ "セッションが  │              │
    │  タイムアウト  │              │
    │  しました。    │              │
    │  もう一度お試  │              │
    │  しください"   │              │
    │◁ ─ ─ ─ ─ ─ ─┤              │
    │               │              │
    │ メッセージ再送信              │
    │──────────────▶│              │
    │               │              │
    │               │  ※ 新しい session_id で
    │               │    正常系フローを実行
    │               │              │
```

### 4.4 デプロイフロー

```
  開発者        AWS CDK      CloudFormation     ECR        AgentCore    Secrets Mgr   Lambda(H/C)   API Gateway    S3         CloudFront
    │              │              │              │             │             │              │             │          │              │
    │ npx cdk      │              │              │             │             │              │             │          │              │
    │ deploy --all │              │              │             │             │              │             │          │              │
    │─────────────▶│              │              │             │             │              │             │          │              │
    │              │              │              │             │             │              │             │          │              │
    │              │  ┌───────────────────────────────────────────────────────────────────────────────────────────────────────────┐│
    │              │  │ Phase 1: ConfeeAgentCoreStack (10〜30分)                                                                 ││
    │              │  └───────────────────────────────────────────────────────────────────────────────────────────────────────────┘│
    │              │              │              │             │             │              │             │          │              │
    │              │ テンプレート  │              │             │             │              │             │          │              │
    │              │ 送信         │              │             │             │              │             │          │              │
    │              │─────────────▶│              │             │             │              │             │          │              │
    │              │              │              │             │             │              │             │          │              │
    │              │              │ Docker イメージ             │             │              │             │          │              │
    │              │              │ ビルド&プッシュ             │             │              │             │          │              │
    │              │              │ (ARM64)      │             │             │              │             │          │              │
    │              │              │─────────────▶│             │             │              │             │          │              │
    │              │              │              │             │             │              │             │          │              │
    │              │              │─┐ IAM Role 作成            │             │              │             │          │              │
    │              │              │◀┘ Custom Resource Lambda x2 デプロイ     │              │             │          │              │
    │              │              │              │             │             │              │             │          │              │
    │              │              │ create_agent_runtime()     │             │              │             │          │              │
    │              │              │───────────────────────────▶│             │              │             │          │              │
    │              │              │              │             │             │              │             │          │              │
    │              │              │              │             │ microVM     │              │             │          │              │
    │              │              │              │             │ 起動待ち... │              │             │          │              │
    │              │              │              │             │ (30秒間隔   │              │             │          │              │
    │              │              │              │             │  ポーリング │              │             │          │              │
    │              │              │              │             │  最大30分)  │              │             │          │              │
    │              │              │              │             │             │              │             │          │              │
    │              │              │ status: READY│             │             │              │             │          │              │
    │              │              │◁ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─┤             │              │             │          │              │
    │              │              │              │             │             │              │             │          │              │
    │              │ 完了:        │              │             │             │              │             │          │              │
    │              │ agentRuntimeArn              │             │              │             │          │              │
    │              │◁ ─ ─ ─ ─ ─ ┤              │             │             │              │             │          │              │
    │              │              │              │             │             │              │             │          │              │
    │              │  ┌───────────────────────────────────────────────────────────────────────────────────────────────────────────┐│
    │              │  │ Phase 2: ConfeeApiStack (約5分)                                                                          ││
    │              │  └───────────────────────────────────────────────────────────────────────────────────────────────────────────┘│
    │              │              │              │             │             │              │             │          │              │
    │              │ テンプレート  │              │             │             │              │             │          │              │
    │              │ 送信         │              │             │             │              │             │          │              │
    │              │ (ARN参照)    │              │             │             │              │             │          │              │
    │              │─────────────▶│              │             │             │              │             │          │              │
    │              │              │              │             │             │              │             │          │              │
    │              │              │ ┌──── 並行作成 ────┐       │             │              │             │          │              │
    │              │              │ │                  │       │             │              │             │          │              │
    │              │              │ │ シークレット作成 │       │             │              │             │          │              │
    │              │              │─┼─────────────────┼──────────────────▶│              │             │          │              │
    │              │              │ │                  │       │             │              │             │          │              │
    │              │              │ │ Lambda デプロイ  │       │             │              │             │          │              │
    │              │              │ │ (AGENT_RUNTIME_ARN設定)  │             │              │             │          │              │
    │              │              │─┼─────────────────┼───────────────────────────────────▶│             │          │              │
    │              │              │ │                  │       │             │              │             │          │              │
    │              │              │ └──────────────────┘       │             │              │             │          │              │
    │              │              │              │             │             │              │             │          │              │
    │              │              │ REST API 作成│             │             │              │             │          │              │
    │              │              │ (/health, /chat)           │             │              │             │          │              │
    │              │              │───────────────────────────────────────────────────────────────────▶│          │              │
    │              │              │              │             │             │              │             │          │              │
    │              │ 完了: apiUrl │              │             │             │              │             │          │              │
    │              │◁ ─ ─ ─ ─ ─ ┤              │             │             │              │             │          │              │
    │              │              │              │             │             │              │             │          │              │
    │              │  ┌───────────────────────────────────────────────────────────────────────────────────────────────────────────┐│
    │              │  │ Phase 3: ConfeeFrontendStack (約5分)                                                                     ││
    │              │  └───────────────────────────────────────────────────────────────────────────────────────────────────────────┘│
    │              │              │              │             │             │              │             │          │              │
    │              │ テンプレート  │              │             │             │              │             │          │              │
    │              │ 送信         │              │             │             │              │             │          │              │
    │              │─────────────▶│              │             │             │              │             │          │              │
    │              │              │              │             │             │              │             │          │              │
    │              │              │ バケット作成 │             │             │              │             │          │              │
    │              │              │───────────────────────────────────────────────────────────────────────────────▶│              │
    │              │              │              │             │             │              │             │          │              │
    │              │              │ CloudFront作成             │             │              │             │          │              │
    │              │              │ (OAC + SPAルーティング)    │             │              │             │          │   作成       │
    │              │              │────────────────────────────────────────────────────────────────────────────────────────────────▶│
    │              │              │              │             │             │              │             │          │              │
    │              │              │ frontend/dist アップロード │             │              │             │          │              │
    │              │              │───────────────────────────────────────────────────────────────────────────────▶│              │
    │              │              │              │             │             │              │             │          │              │
    │              │              │ キャッシュ無効化            │             │              │             │          │  無効化      │
    │              │              │────────────────────────────────────────────────────────────────────────────────────────────────▶│
    │              │              │              │             │             │              │             │          │              │
    │              │ 完了:        │              │             │             │              │             │          │              │
    │              │ cloudFrontUrl│              │             │             │              │             │          │              │
    │              │◁ ─ ─ ─ ─ ─ ┤              │             │             │              │             │          │              │
    │              │              │              │             │             │              │             │          │              │
    │ デプロイ完了  │              │              │             │             │              │             │          │              │
    │◁ ─ ─ ─ ─ ─ ┤              │              │             │             │              │             │          │              │
    │              │              │              │             │             │              │             │          │              │
    │  ※ デプロイ後: Secrets Manager に connpass API キーを手動登録         │              │             │          │              │
    │              │              │              │             │             │              │             │          │              │
```

---

## 5. セッション管理フロー

### セッション ID のライフサイクル

```
  ユーザー      React SPA         Chat Lambda     AgentCore
                (ChatContainer)                    Runtime
    │               │                  │              │
    │               │                  │              │
    │    ┌──────────────────────────────────────────────────┐
    │    │ アプリ起動時                                     │
    │    └──────────────────────────────────────────────────┘
    │               │                  │              │
    │               │─┐ session_id 生成│              │
    │               │◀┘ crypto.randomUUID()           │
    │               │                  │              │
    │    ┌──────────────────────────────────────────────────┐
    │    │ 1回目のメッセージ                                │
    │    └──────────────────────────────────────────────────┘
    │               │                  │              │
    │ メッセージ送信│                  │              │
    │──────────────▶│                  │              │
    │               │ {message,        │              │
    │               │  session_id:     │              │
    │               │  "abc-123"}      │              │
    │               │─────────────────▶│              │
    │               │                  │ {prompt,     │
    │               │                  │  runtimeSessionId:
    │               │                  │  "abc-123"}  │
    │               │                  │─────────────▶│
    │               │                  │              │
    │               │                  │  {response,  │
    │               │                  │   runtimeSessionId:
    │               │                  │   "abc-123"} │
    │               │                  │◁ ─ ─ ─ ─ ─ ┤
    │               │  {response,      │              │
    │               │   session_id:    │              │
    │               │   "abc-123"}     │              │
    │               │◁ ─ ─ ─ ─ ─ ─ ─ ┤              │
    │               │                  │              │
    │               │─┐ sessionIdRef   │              │
    │               │◀┘ を更新         │              │
    │               │                  │              │
    │    ┌──────────────────────────────────────────────────┐
    │    │ 2回目のメッセージ (同一セッション)                │
    │    └──────────────────────────────────────────────────┘
    │               │                  │              │
    │ メッセージ送信│                  │              │
    │──────────────▶│                  │              │
    │               │ {message,        │              │
    │               │  session_id:     │              │
    │               │  "abc-123"}      │              │
    │               │─────────────────▶│              │
    │               │                  │─────────────▶│
    │               │                  │              │─┐ 同一 session_id で
    │               │                  │              │◀┘ 会話コンテキスト維持
    │               │                  │◁ ─ ─ ─ ─ ─ ┤
    │               │◁ ─ ─ ─ ─ ─ ─ ─ ┤              │
    │◁ ─ ─ ─ ─ ─ ─┤                  │              │
    │               │                  │              │
    │    ┌──────────────────────────────────────────────────┐
    │    │ セッションリセット                               │
    │    └──────────────────────────────────────────────────┘
    │               │                  │              │
    │ 「新しい会話」 │                  │              │
    │ ボタンクリック│                  │              │
    │──────────────▶│                  │              │
    │               │─┐ sessionKey インクリメント     │
    │               │◀┘ 新しい session_id 生成        │
    │               │   メッセージ履歴クリア          │
    │               │                  │              │
    │    ┌──────────────────────────────────────────────────┐
    │    │ セッションタイムアウト時                         │
    │    └──────────────────────────────────────────────────┘
    │               │                  │              │
    │ メッセージ送信│                  │              │
    │──────────────▶│                  │              │
    │               │ {session_id:     │              │
    │               │  "old-session"}  │              │
    │               │─────────────────▶│              │
    │               │                  │              │
    │               │  HTTP 408        │              │
    │               │◁ ─ ─ ─ ─ ─ ─ ─ ┤              │
    │               │                  │              │
    │               │─┐ 自動で新しい session_id 生成  │
    │               │◀┘                │              │
    │               │                  │              │
    │ タイムアウト   │                  │              │
    │ メッセージ表示│                  │              │
    │ 再送信を促す  │                  │              │
    │◁ ─ ─ ─ ─ ─ ─┤                  │              │
    │               │                  │              │
```

### セッション状態の管理場所

| レイヤー | 管理内容 | 保持期間 |
|---------|---------|---------|
| フロントエンド | session_id, メッセージ履歴 (React state) | ページリロードまで |
| AgentCore Runtime | 会話コンテキスト (microVM 内) | セッションタイムアウトまで |

---

## 6. タイムアウト設定一覧

| コンポーネント | タイムアウト | 用途 |
|--------------|------------|------|
| connpass API 呼び出し | 5 秒 | `search_connpass` ツールの HTTP タイムアウト |
| Health Lambda | 10 秒 | ヘルスチェック Lambda の実行時間上限 |
| Chat Lambda | 30 秒 | チャットプロキシ Lambda の実行時間上限 |
| Custom Resource Lambda | 5 分 | AgentCore Runtime 管理 Lambda の実行時間上限 |
| Custom Resource Provider | 30 分 | AgentCore Runtime 作成完了待ちの最大時間 |
| Custom Resource ポーリング | 30 秒 | AgentCore Runtime ステータス確認間隔 |
